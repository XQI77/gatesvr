# 时延监控功能使用指南

## 概述

本项目新增了详细的时延监控功能，可以帮助您深入了解系统性能瓶颈：

1. **Client端时延监控**：客户端到网关服务器的消息往返时延(RTT)
2. **Gateway端详细时延监控**：网关服务器各处理阶段的详细时延分解

## 监控指标

### Client端时延指标

- **往返时延(RTT)**：从发送请求到收到响应的总时间
- **时延统计**：平均值、最小值、最大值、P95、P99等统计指标
- **样本数量**：用于统计的请求数量

### Gateway端时延指标

**处理阶段分解：**

1. **消息解析时延** (`parse_latency`)：解析客户端请求消息的时间
2. **上游调用时延** (`upstream_latency`)：调用上游服务的时间
3. **响应编码时延** (`encode_latency`)：编码响应消息的时间
4. **消息发送时延** (`send_latency`)：发送响应到客户端的时间
5. **总处理时延** (`total_latency`)：端到端处理时间

**每个阶段都包含：**
- 处理次数
- 平均时延
- 最小/最大时延
- P95/P99时延

## API接口

### 现有接口扩展

1. **性能统计** - `GET /performance`
   - 包含所有基础性能指标
   - 新增 `detailed_latency` 字段，包含各阶段详细时延

### 新增专用接口

2. **详细时延查询** - `GET /latency/detailed`
   ```json
   {
     "detailed_latency": {
       "parse_latency": {
         "count": 1000,
         "avg_latency_ms": 0.15,
         "min_latency_ms": 0.05,
         "max_latency_ms": 2.30,
         "p95_latency_ms": 0.45,
         "p99_latency_ms": 0.89
       },
       "upstream_latency": { ... },
       "encode_latency": { ... },
       "send_latency": { ... },
       "total_latency": { ... }
     },
     "summary": {
       "description": "各处理阶段的详细时延统计",
       "stages": { ... }
     }
   }
   ```

3. **时延分类统计** - `GET /latency/breakdown`
   - 按功能分类的时延统计
   - 包括消息处理、上游处理、网络处理等分类

4. **客户端时延查询** - `GET /latency/client`
   - 专门用于客户端时延相关信息

## 监控工具使用

### monitor 工具新增选项

```bash
# 基础性能监控
./bin/monitor.exe -server localhost:8080

# 显示详细时延分解
./bin/monitor.exe -server localhost:8080 -detailed

# 显示时延分类统计
./bin/monitor.exe -server localhost:8080 -breakdown

# 持续监控（包含时延信息）
./bin/monitor.exe -server localhost:8080 -continuous -interval 3s

# JSON格式输出
./bin/monitor.exe -server localhost:8080 -detailed -format json
```

### 输出示例

**基础监控（现在包含时延分解）：**
```
========================================
         网关服务器性能监控
========================================
运行时间:         120.5 秒 (0.0 小时)
总连接数:         45
活跃连接数:       12
总请求数:         1250
总响应数:         1245
总错误数:         5
成功率:           99.60%
QPS:              10.37 请求/秒
吞吐量:           2.45 MB/s
总字节数:         354.2 MB
平均延迟:         15.23 ms
最小延迟:         2.10 ms
最大延迟:         89.45 ms
P95延迟:          28.67 ms
P99延迟:          45.23 ms
延迟样本数:       1000
----------------------------------------
         详细时延分解统计
----------------------------------------
消息解析          平均: 0.15ms, P95: 0.45ms, 次数: 1250
上游调用          平均: 12.45ms, P95: 24.67ms, 次数: 1200
响应编码          平均: 0.23ms, P95: 0.67ms, 次数: 1245
消息发送          平均: 0.18ms, P95: 0.54ms, 次数: 1245
总处理            平均: 15.23ms, P95: 28.67ms, 次数: 1250
========================================
```

**详细时延分解：**
```
========================================
         详细时延分解统计
========================================

消息解析时延:
  处理次数:       1250
  平均时延:       0.15 ms
  最小时延:       0.05 ms
  最大时延:       2.30 ms
  P95时延:        0.45 ms
  P99时延:        0.89 ms

上游调用时延:
  处理次数:       1200
  平均时延:       12.45 ms
  最小时延:       1.20 ms
  最大时延:       85.67 ms
  P95时延:        24.67 ms
  P99时延:        42.15 ms

...
========================================
```

## 性能优化建议

基于时延监控数据，您可以识别性能瓶颈：

1. **消息解析时延过高**：
   - 检查消息格式复杂度
   - 考虑消息压缩或简化

2. **上游调用时延过高**：
   - 优化上游服务性能
   - 增加连接池
   - 考虑缓存策略

3. **响应编码时延过高**：
   - 检查响应数据大小
   - 优化序列化算法

4. **消息发送时延过高**：
   - 检查网络带宽
   - 优化消息大小
   - 调整缓冲区设置

## 日志输出改进

现在的日志输出包含更详细的时延信息：

```
处理业务请求 - 动作: getUserInfo, 会话: sess_123, 响应码: 200, 
时延: 解析=0.12ms, 上游=15.67ms, 编码=0.18ms

消息往返时延: 18.45ms, 消息ID: 1001

发送推送消息 - 类型: 2, 序列号: 5001, 会话: sess_123, 
编码时延: 0.15ms, 发送时延: 0.22ms
```

## 集成建议

1. **监控告警**：
   - 设置时延阈值告警
   - 监控P95/P99指标趋势

2. **性能分析**：
   - 定期分析各阶段时延分布
   - 识别异常请求模式

3. **容量规划**：
   - 基于时延数据进行容量规划
   - 预测系统瓶颈

这些时延监控功能将帮助您更好地理解和优化系统性能！ 