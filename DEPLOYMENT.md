# 主从 GateServer 部署指南

## 端口配置架构

### 同机测试环境

**主服务器端口分配：**
- QUIC 服务：8443
- HTTP API：8080  
- gRPC 服务：8082
- 监控指标：9090
- 心跳发送目标：localhost:8455
- 同步发送目标：localhost:8456

**备份服务器端口分配：**
- QUIC 服务：8453
- HTTP API：8090
- gRPC 服务：8092  
- 监控指标：9100
- 心跳监听：8455
- 同步监听：8456

### 跨机器部署环境

**主服务器 (192.168.1.10)：**
- QUIC 服务：8443
- HTTP API：8080
- gRPC 服务：8082
- 监控指标：9090
- 心跳发送目标：192.168.1.11:8455
- 同步发送目标：192.168.1.11:8456

**备份服务器 (192.168.1.11)：**
- QUIC 服务：8443 (与主服务器相同端口，但在不同机器)
- HTTP API：8080
- gRPC 服务：8082
- 监控指标：9090
- 心跳监听：8455
- 同步监听：8456

## 配置文件说明

### 同机测试配置
- `config.yaml` - 主服务器配置
- `config-backup.yaml` - 备份服务器配置

### 跨机器部署配置
- `config-primary-remote.yaml` - 主服务器跨机器配置
- `config-backup-remote.yaml` - 备份服务器跨机器配置

## 启动方式

### 同机测试
```bash
# 启动备份服务器
scripts\start-backup.bat

# 启动主服务器  
scripts\start-primary.bat
```

### 跨机器部署
```bash
# 在备份服务器机器 (192.168.1.11) 上：
.\bin\gatesvr.exe -config config-backup-remote.yaml

# 在主服务器机器 (192.168.1.10) 上：
.\bin\gatesvr.exe -config config-primary-remote.yaml
```

## 防火墙配置

跨机器部署时需要开放以下端口：

**主服务器需要开放：**
- 8443 (QUIC - 客户端连接)
- 8080 (HTTP API)
- 9090 (监控指标)

**备份服务器需要开放：**
- 8443 (QUIC - 故障切换时客户端连接)  
- 8080 (HTTP API)
- 8455 (心跳接收)
- 8456 (同步接收)
- 9090 (监控指标)

## 连接架构

```
主服务器 (Primary)           备份服务器 (Backup)
─────────────────           ─────────────────
QUIC: 8443                 QUIC: 8443/8453
HTTP: 8080                 HTTP: 8080/8090
监控: 9090                 监控: 9090/9100

心跳发送 ────────────────────→ 心跳监听: 8455
同步发送 ────────────────────→ 同步监听: 8456
```

**关键特性：**
- ✅ 单向连接：只有主服务器主动连接备份服务器
- ✅ 端口分离：心跳和同步使用不同端口，避免冲突
- ✅ 灵活部署：支持同机测试和跨机器部署
- ✅ 故障切换：备份服务器可在故障时接管客户端连接